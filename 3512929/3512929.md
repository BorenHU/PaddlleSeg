# 1. é¡¹ç›®ç®€ä»‹
æœ¬é¡¹ç›®ä»‹ç»å¦‚ä½•ä»é›¶å¼€å§‹å®Œæˆä¸€ä¸ªå›¾åƒåˆ†å‰²ä»»åŠ¡ã€‚é€šè¿‡è‡ªå»ºæ•°æ®é›†ï¼Œå¹¶åˆ†åˆ«ä½¿ç”¨åŸºäºPaddle2.0å’ŒPaddleSeg2.0çš„æ–¹æ³•å®Œæˆå›¾åƒåˆ†å‰²ä»»åŠ¡ã€‚

## 1.1 ä»€ä¹ˆæ˜¯å›¾åƒåˆ†å‰²
å›¾åƒåˆ†å‰²æ˜¯ä¸€ç§å…¸å‹çš„è®¡ç®—æœºè§†è§‰ä»»åŠ¡ï¼ŒæŒ‡çš„æ˜¯å°†ä¸€å¼ å›¾åƒåˆ†å‰²æˆæ—¢å®šç±»åˆ«çš„å‡ ä¸ªåŒºåŸŸã€‚å›¾åƒåˆ†å‰²æœ¬è´¨ä¸Šæ˜¯ä¸€ç§åƒç´ çº§åˆ«çš„å›¾åƒåˆ†ç±»ä»»åŠ¡ã€‚

å›¾åƒåˆ†å‰²é€šå¸¸åˆ†ä¸ºè¯­ä¹‰åˆ†å‰²ã€å®ä¾‹åˆ†å‰²ã€å…¨æ™¯åˆ†å‰²ï¼Œå¦‚å›¾1æ‰€ç¤ºã€‚å¦å¤–ï¼Œè¿˜æœ‰åŸºäºè§†é¢‘çš„ç›®æ ‡åˆ†å‰²å’Œå®ä¾‹åˆ†å‰²ã€‚æœ¬é¡¹ç›®ä¸­æˆ‘ä»¬å°†å®Œæˆä¸€ä¸ªå›¾åƒè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ã€‚

<div style="text-align: center">
<img src="https://ai-studio-static-online.cdn.bcebos.com/5e4536b0637c4b5397aa4e95d26117e271518beaf1774eb2a9b786475e6259db" width="600">
  <p style="margin-top: 20px">å›¾1 å›¾åƒåˆ†å‰²ä»»åŠ¡ç¤ºæ„å›¾</p>
</div>


# 2. åˆ›å»ºæ•°æ®é›†
æœ¬é¡¹ç›®é‡‡ç”¨è‡ªå»ºçš„é¸½å­å›¾ç‰‡æ•°æ®é›†ã€‚åˆ›å»ºæ•°æ®é›†åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š
## 2.1. æ‹æ‘„é¸½å­çš„ç…§ç‰‡ã€‚
æ‹æ‘„é¸½å­å›¾ç‰‡æ—¶å°½é‡é€‰æ‹©ä¸åŒè§’åº¦ã€ä¸åŒèƒŒæ™¯è¿›è¡Œæ‹æ‘„ï¼Œå›¾ç‰‡ä¸­çš„é¸½å­æ•°é‡ä¹Ÿå°½é‡ä¸åŒï¼Œä»¥ä¾¿å¢åŠ å›¾ç‰‡çš„å¤šæ ·æ€§ä»è€Œæé«˜æœ€åæ¨¡å‹çš„é²æ£’æ€§ã€‚ç”±äºæœ¬é¡¹ç›®åªæ˜¯è®²è¿°æµç¨‹ï¼Œæ•…è¿™é‡Œä»…é‡‡ç”¨äº†124å¼ ç…§ç‰‡ã€‚

## 2.2. ä½¿ç”¨labelmeè¿›è¡Œæ ‡æ³¨ã€‚
ä¸¥æ ¼æŒ‰ç…§labelme githubä»“åº“ä¸»é¡µçš„æè¿°æ¥å®‰è£…labelmeï¼Œé“¾æ¥ä¸º[labelme githubç½‘å€](https://github.com/wkentaro/labelme)

## 2.3. åŸºäºæ ‡æ³¨å¥½çš„å›¾ç‰‡åˆ©ç”¨jsonæ–‡ä»¶ç”ŸæˆåŸå§‹å›¾ç‰‡å’Œæ ‡ç­¾å›¾ç‰‡ã€‚
ä½¿ç”¨labelmeå®Œæˆæ ‡æ³¨ä»»åŠ¡åï¼Œéœ€è¦åˆ©ç”¨ä¿å­˜çš„jsonæ–‡ä»¶æ¥ç”ŸæˆåŸå§‹å›¾ç‰‡å’Œå¯¹åº”çš„æ ‡ç­¾å›¾ç‰‡ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºlabelmeè‡ªå¸¦çš„labelme_json_to_datasetå‘½ä»¤åªèƒ½å¤„ç†å•ä¸ªjsonæ–‡ä»¶ï¼Œå¦‚æœè¦æ‰¹é‡å¤„ç†æ‰€æœ‰ç”Ÿæˆçš„jsonæ–‡ä»¶å¯ä»¥é‡‡ç”¨å¹¶ä¿®æ”¹å¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼š
```
import os
path = PATH_TO_JSON
json_file = os.listdir(path)
#os.system("conda activate labelme")
for file in json_file:
    os.system("labelme_json_to_dataset %s"%(path+"/"+file))
```
## 2.4. ä½¿ç”¨AI Studioåˆ›å»ºå¹¶ä¸Šä¼ æ ‡æ³¨å¥½çš„å›¾ç‰‡ã€‚
é€šå¸¸ç”Ÿæˆçš„æ•°æ®é›†è¾ƒå¤§ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨AI Studioçš„åˆ›å»ºæ•°æ®é›†åŠŸèƒ½ä¸Šä¼ ç”Ÿæˆçš„æ•°æ®ï¼Œç„¶ååœ¨é¡¹ç›®ä¸­æŒ‚è½½ä½¿ç”¨ã€‚

å®Œæˆä»¥ä¸Šæ­¥éª¤åå°±å¯ä»¥ä½¿ç”¨AI Studioè¿›è¡Œè®­ç»ƒã€éªŒè¯å’Œé¢„æµ‹äº†ã€‚

# 3. è®­ç»ƒã€éªŒè¯å’Œé¢„æµ‹
ä¸‹é¢ä»¥U-Netç½‘ç»œä¸ºä¾‹ï¼Œè®²è¿°ä¸¤ç§è¿›è¡Œè®­ç»ƒã€éªŒè¯å’Œé¢„æµ‹çš„æ–¹æ³•ï¼šåŸºäºPaddle2.0 APIçš„æ–¹æ³•å’ŒåŸºäºPaddleSeg2.0çš„æ–¹æ³•ã€‚

## 3.1 åŸºäºPaddle2.0 APIä½¿ç”¨U-Netç½‘ç»œå®ç°é¸½å­å›¾åƒçš„è¯­ä¹‰åˆ†å‰²ä»»åŠ¡

è¿™éƒ¨åˆ†å€Ÿé‰´äº†é¡¹ç›®[ã€è·Ÿç€é›¨å“¥å­¦AIã€ç³»åˆ—06ï¼šè¶£å‘³æ¡ˆä¾‹â€”â€”åŸºäºU-Netçš„å® ç‰©å›¾åƒåˆ†å‰²](https://aistudio.baidu.com/aistudio/projectdetail/1246330) 
çš„éƒ¨åˆ†å†…å®¹ã€‚

### 3.1.1 ç®€è¦ä»‹ç»
U-Netç½‘ç»œç»“æ„æ˜¯ä¸€ä¸ªåŸºäºFCNå¹¶æ”¹è¿›åçš„æ·±åº¦å­¦ä¹ ç½‘ç»œï¼ŒåŒ…å«ä¸‹é‡‡æ ·ï¼ˆç¼–ç å™¨ï¼Œç‰¹å¾æå–ï¼‰å’Œä¸Šé‡‡æ ·ï¼ˆè§£ç å™¨ï¼Œåˆ†è¾¨ç‡è¿˜åŸï¼‰ä¸¤ä¸ªé˜¶æ®µï¼Œå› æ¨¡å‹ç»“æ„æ¯”è¾ƒåƒUå‹è€Œå‘½åä¸ºU-Netã€‚

### 3.1.2.ç¯å¢ƒè®¾ç½®

å¯¼å…¥ä¸€äº›æ¯”è¾ƒåŸºç¡€å¸¸ç”¨çš„æ¨¡å—ï¼Œç¡®è®¤è‡ªå·±çš„é£æ¡¨ç‰ˆæœ¬ã€‚


```python
import os
import io
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image as PilImage

import paddle
from paddle.nn import functional as F

import warnings
warnings.filterwarnings('ignore') 

paddle.__version__
```




    '2.2.2'



### 3.1.3 è§£å‹æ•°æ®é›†


```python
!unzip -oq /home/aistudio/data/data75217/doves.zip -d work/doves
```

### 3.1.4 æ•°æ®é›†æ¦‚è§ˆ

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬çš„æ•°æ®é›†ã€‚

æ•°æ®é›†è§£å‹åï¼Œé‡Œé¢æ”¾çš„æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­æœ‰å››ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯å›¾ç‰‡æ–‡ä»¶ã€æ ‡ç­¾æ–‡ä»¶ã€æ ‡ç­¾åå­—æ–‡ä»¶å’Œå¯è§†åŒ–çš„å›¾ç‰‡æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```bash
.
â”œâ”€â”€ label.png
â”œâ”€â”€ img.png
â”œâ”€â”€ label_names.txt
â””â”€â”€ label_viz.png
```

æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ•°æ®é›†ç»™æˆ‘ä»¬æä¾›äº†å¤šå°‘ä¸ªè®­ç»ƒæ ·æœ¬ã€‚


```python
images_path = "work/doves"
image_count = len([os.path.join(images_path, image_name) 
          for image_name in os.listdir(images_path)])
print("ç”¨äºè®­ç»ƒçš„å›¾ç‰‡æ ·æœ¬æ•°é‡:", image_count)
```

    ç”¨äºè®­ç»ƒçš„å›¾ç‰‡æ ·æœ¬æ•°é‡: 124


### 3.1.5 åˆ’åˆ†è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†


```python
def _sort_images(image_dir):
    """
    å¯¹æ–‡ä»¶å¤¹å†…çš„å›¾åƒè¿›è¡ŒæŒ‰ç…§æ–‡ä»¶åæ’åº
    """
    images = []
    labels = []

    for image_name in os.listdir(image_dir):
        if os.path.isdir(os.path.join(image_dir, image_name)):
            images.append(os.path.join(os.path.join(image_dir, image_name), 'img.png'))
            labels.append(os.path.join(os.path.join(image_dir, image_name), 'label.png'))

    return sorted(images), sorted(labels)
"""
è¿™é‡Œçš„åˆ†å‰²ç¬¦æ˜¯\tï¼Œåé¢ä½¿ç”¨PaddleSegçš„æ—¶å€™è¦æ³¨æ„ä¿®æ”¹ç›¸å…³ä»£ç ï¼Œå› ä¸ºPaddleSegè¯»å–æ–‡ä»¶æ—¶é»˜è®¤çš„åˆ†å‰²ç¬¦æ˜¯ç©ºæ ¼ã€‚
å½“ç„¶ä¹Ÿå¯ä»¥å°†è¿™é‡Œçš„\tæ›¿æ¢ä¸ºç©ºæ ¼ã€‚
"""
def write_file(mode, images, labels):
    with open('./{}.txt'.format(mode), 'w') as f:
        for i in range(len(images)):
            f.write('{}\t{}\n'.format(images[i], labels[i]))
    
"""
ç”±äºæ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯æ•£è½åœ¨æ–‡ä»¶å¤¹ä¸­ï¼Œåœ¨è®­ç»ƒæ—¶æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯æ•°æ®é›†å’Œæ ‡ç­¾å¯¹åº”çš„æ•°æ®å…³ç³»ï¼Œ
æ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ­¥æ˜¯å¯¹åŸå§‹çš„æ•°æ®é›†è¿›è¡Œæ•´ç†ï¼Œå¾—åˆ°æ•°æ®é›†å’Œæ ‡ç­¾ä¸¤ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«ä¸€ä¸€å¯¹åº”ã€‚
è¿™æ ·å¯ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„æ‰¾åˆ°åŸå§‹æ•°æ®å’Œæ ‡ç­¾çš„å¯¹åº”å…³ç³»ï¼Œå¦åˆ™å¯¹äºåŸæœ‰çš„æ–‡ä»¶å¤¹å›¾ç‰‡æ•°æ®æ— æ³•ç›´æ¥åº”ç”¨ã€‚
"""
images, labels = _sort_images(images_path)
eval_num = int(image_count * 0.15)

"""
ç”±äºå›¾ç‰‡æ•°é‡æœ‰é™ï¼Œè¿™é‡Œçš„æµ‹è¯•é›†å’ŒéªŒè¯é›†é‡‡ç”¨ç›¸åŒçš„ä¸€ç»„å›¾ç‰‡ã€‚
"""
write_file('train', images[:-eval_num], labels[:-eval_num])
write_file('test', images[-eval_num:], labels[-eval_num:])
write_file('eval', images[-eval_num:], labels[-eval_num:])
```

### 3.1.6 DoveDataSetæ•°æ®é›†æŠ½æ ·å±•ç¤º

åˆ’åˆ†å¥½æ•°æ®é›†ä¹‹åï¼Œæˆ‘ä»¬æ¥æŸ¥éªŒä¸€ä¸‹æ•°æ®é›†æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œæˆ‘ä»¬é€šè¿‡åˆ’åˆ†çš„é…ç½®æ–‡ä»¶è¯»å–å›¾ç‰‡è·¯å¾„åå†åŠ è½½å›¾ç‰‡æ•°æ®æ¥ç”¨matplotlibè¿›è¡Œå±•ç¤ºï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¯¹äºåˆ†å‰²çš„æ ‡ç­¾æ–‡ä»¶å› ä¸ºæ˜¯1é€šé“çš„ç°åº¦å›¾ç‰‡ï¼Œéœ€è¦åœ¨ä½¿ç”¨imshowæ¥å£æ—¶æ³¨æ„ä¸‹ä¼ å‚cmap='gray'ã€‚


```python
with open('./train.txt', 'r') as f:
    i = 0

    for line in f.readlines():
        image_path, label_path = line.strip().split('\t')
        image = np.array(PilImage.open(image_path))
        label = np.array(PilImage.open(label_path))
    
        if i > 2:
            break
        # è¿›è¡Œå›¾ç‰‡çš„å±•ç¤º
        plt.figure()

        plt.subplot(1,2,1), 
        plt.title('Train Image')
        plt.imshow(image.astype('uint8'))
        plt.axis('off')

        plt.subplot(1,2,2), 
        plt.title('Label')
        plt.imshow(label.astype('uint8'), cmap='gray')
        plt.axis('off')

        plt.show()
        i = i + 1
```


![png](output_15_0.png)



![png](output_15_1.png)



![png](output_15_2.png)


### 3.1.7 æ•°æ®é›†ç±»å®šä¹‰

é£æ¡¨ï¼ˆPaddlePaddleï¼‰æ•°æ®é›†åŠ è½½æ–¹æ¡ˆæ˜¯ç»Ÿä¸€ä½¿ç”¨Datasetï¼ˆæ•°æ®é›†å®šä¹‰ï¼‰ + DataLoaderï¼ˆå¤šè¿›ç¨‹æ•°æ®é›†åŠ è½½ï¼‰ã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆè¿›è¡Œæ•°æ®é›†çš„å®šä¹‰ï¼Œæ•°æ®é›†å®šä¹‰ä¸»è¦æ˜¯å®ç°ä¸€ä¸ªæ–°çš„Datasetç±»ï¼Œç»§æ‰¿çˆ¶ç±»paddle.io.Datasetï¼Œå¹¶å®ç°çˆ¶ç±»ä¸­ä»¥ä¸‹ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œ`__getitem__`å’Œ`__len__`ï¼š

```python
class MyDataset(Dataset):
    def __init__(self):
        ...
        
    # æ¯æ¬¡è¿­ä»£æ—¶è¿”å›æ•°æ®å’Œå¯¹åº”çš„æ ‡ç­¾
    def __getitem__(self, idx):
        return x, y

    # è¿”å›æ•´ä¸ªæ•°æ®é›†çš„æ€»æ•°
    def __len__(self):
        return count(samples)
```

åœ¨æ•°æ®é›†å†…éƒ¨å¯ä»¥ç»“åˆå›¾åƒæ•°æ®é¢„å¤„ç†ç›¸å…³APIè¿›è¡Œå›¾åƒçš„é¢„å¤„ç†ï¼ˆæ”¹å˜å¤§å°ã€åè½¬ã€è°ƒæ•´æ ¼å¼ç­‰ï¼‰ã€‚

ç”±äºåŠ è½½è¿›æ¥çš„å›¾åƒä¸ä¸€å®šéƒ½ç¬¦åˆè‡ªå·±çš„éœ€æ±‚ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå·²ä¸‹è½½çš„è¿™äº›å›¾ç‰‡é‡Œé¢å°±ä¼šæœ‰RGBAæ ¼å¼çš„å›¾ç‰‡ï¼Œè¿™ä¸ªæ—¶å€™å›¾ç‰‡å°±ä¸ç¬¦åˆæˆ‘ä»¬æ‰€éœ€3é€šé“çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œå›¾ç‰‡çš„æ ¼å¼è½¬æ¢ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬ç›´æ¥å®ç°äº†ä¸€ä¸ªé€šç”¨çš„å›¾ç‰‡è¯»å–æ¥å£ï¼Œç¡®ä¿è¯»å–å‡ºæ¥çš„å›¾ç‰‡éƒ½æ˜¯æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

å¦å¤–å›¾ç‰‡åŠ è½½å‡ºæ¥çš„é»˜è®¤shapeæ˜¯HWCï¼Œè¿™ä¸ªæ—¶å€™è¦çœ‹çœ‹æ˜¯å¦æ»¡è¶³åé¢è®­ç»ƒçš„éœ€è¦ï¼Œå¦‚æœLayerçš„é»˜è®¤æ ¼å¼å’Œè¿™ä¸ªä¸æ˜¯ç¬¦åˆçš„æƒ…å†µä¸‹ï¼Œéœ€è¦çœ‹ä¸‹Layeræœ‰æ²¡æœ‰å‚æ•°å¯ä»¥è¿›è¡Œæ ¼å¼è°ƒæ•´ã€‚ä¸è¿‡å¦‚æœlayerè¾ƒå¤šçš„è¯ï¼Œè¿˜æ˜¯ç›´æ¥è°ƒæ•´åŸæ•°æ®Shapeæ¯”è¾ƒå¥½ï¼Œå¦åˆ™æ¯ä¸ªlayeréƒ½è¦åšå‚æ•°è®¾ç½®ï¼Œå¦‚æœæœ‰é—æ¼å°±ä¼šå¯¼è‡´è®­ç»ƒå‡ºé”™ï¼Œé‚£ä¹ˆåœ¨æœ¬æ¡ˆä¾‹ä¸­æ˜¯ç›´æ¥å¯¹æ•°æ®æºçš„shapeåšäº†ç»Ÿä¸€è°ƒæ•´ï¼Œä»HWCè½¬æ¢æˆäº†CHWï¼Œå› ä¸ºé£æ¡¨çš„å·ç§¯ç­‰APIçš„é»˜è®¤è¾“å…¥æ ¼å¼ä¸ºCHWï¼Œè¿™æ ·å¤„ç†æ–¹ä¾¿åç»­æ¨¡å‹è®­ç»ƒã€‚

æœ¬é¡¹ç›®çš„æ•°æ®é›†å®šä¹‰çš„ä»£ç å¯ä»¥å‚è€ƒcodeç›®å½•ä¸‹çš„dove_dataset.pyæ–‡ä»¶ã€‚

### 3.1.8 æ¨¡å‹ç»„ç½‘

U-Netæ˜¯ä¸€ä¸ªUå‹ç½‘ç»œç»“æ„ï¼Œå¯ä»¥çœ‹åšä¸¤ä¸ªå¤§çš„é˜¶æ®µï¼Œå›¾åƒå…ˆç»è¿‡Encoderç¼–ç å™¨è¿›è¡Œä¸‹é‡‡æ ·å¾—åˆ°é«˜çº§è¯­ä¹‰ç‰¹å¾å›¾ï¼Œå†ç»è¿‡Decoderè§£ç å™¨ä¸Šé‡‡æ ·å°†ç‰¹å¾å›¾æ¢å¤åˆ°åŸå›¾ç‰‡çš„åˆ†è¾¨ç‡ã€‚

å…·ä½“çš„ç½‘ç»œå®šä¹‰çš„ä»£ç å¯ä»¥å‚è€ƒcodeç›®å½•ä¸‹çš„unet.pyæ–‡ä»¶,å…·ä½“ç½‘ç»œç»“æ„åŒ…æ‹¬å¦‚ä¸‹å‡ éƒ¨åˆ†ã€‚

### 3.1.9 å®šä¹‰SeparableConv2Dæ¥å£

æˆ‘ä»¬ä¸ºäº†å‡å°‘å·ç§¯æ“ä½œä¸­çš„è®­ç»ƒå‚æ•°æ¥æå‡æ€§èƒ½ï¼Œæ˜¯ç»§æ‰¿paddle.nn.Layerè‡ªå®šä¹‰äº†ä¸€ä¸ªSeparableConv2D Layerç±»ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯æŠŠ`filter_size * filter_size * num_filters`çš„Conv2Dæ“ä½œæ‹†è§£ä¸ºä¸¤ä¸ªå­Conv2Dï¼Œå…ˆå¯¹è¾“å…¥æ•°æ®çš„æ¯ä¸ªé€šé“ä½¿ç”¨`filter_size * filter_size * 1`çš„å·ç§¯æ ¸è¿›è¡Œè®¡ç®—ï¼Œè¾“å…¥è¾“å‡ºé€šé“æ•°ç›®ç›¸åŒï¼Œä¹‹ååœ¨ä½¿ç”¨`1 * 1 * num_filters`çš„å·ç§¯æ ¸è®¡ç®—ã€‚

### 3.1.10 å®šä¹‰Encoderç¼–ç å™¨

æˆ‘ä»¬å°†ç½‘ç»œç»“æ„ä¸­çš„Encoderä¸‹é‡‡æ ·è¿‡ç¨‹è¿›è¡Œäº†ä¸€ä¸ªLayerå°è£…ï¼Œæ–¹ä¾¿åç»­è°ƒç”¨ï¼Œå‡å°‘ä»£ç ç¼–å†™ï¼Œä¸‹é‡‡æ ·æ˜¯æœ‰ä¸€ä¸ªæ¨¡å‹é€æ¸å‘ä¸‹ç”»æ›²çº¿çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯ä¸æ–­çš„é‡å¤ä¸€ä¸ªå•å…ƒç»“æ„å°†é€šé“æ•°ä¸æ–­å¢åŠ ï¼Œå½¢çŠ¶ä¸æ–­ç¼©å°ï¼Œå¹¶ä¸”å¼•å…¥æ®‹å·®ç½‘ç»œç»“æ„ï¼Œæˆ‘ä»¬å°†è¿™äº›éƒ½æŠ½è±¡å‡ºæ¥è¿›è¡Œç»Ÿä¸€å°è£…ã€‚

### 3.1.11 å®šä¹‰Decoderè§£ç å™¨

åœ¨é€šé“æ•°è¾¾åˆ°æœ€å¤§å¾—åˆ°é«˜çº§è¯­ä¹‰ç‰¹å¾å›¾åï¼Œç½‘ç»œç»“æ„ä¼šå¼€å§‹è¿›è¡Œdecodeæ“ä½œï¼Œè¿›è¡Œä¸Šé‡‡æ ·ï¼Œé€šé“æ•°é€æ¸å‡å°ï¼Œå¯¹åº”å›¾ç‰‡å°ºå¯¸é€æ­¥å¢åŠ ï¼Œç›´è‡³æ¢å¤åˆ°åŸå›¾åƒå¤§å°ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹é‡Œé¢ä¹Ÿæ˜¯é€šè¿‡ä¸æ–­çš„é‡å¤ç›¸åŒç»“æ„çš„æ®‹å·®ç½‘ç»œå®Œæˆï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ä¸ºäº†å‡å°‘ä»£ç ç¼–å†™ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸€ä¸ªLayeræ¥æ”¾åˆ°æ¨¡å‹ç»„ç½‘ä¸­ä½¿ç”¨ã€‚

### 3.1.12 è®­ç»ƒæ¨¡å‹ç»„ç½‘

æŒ‰ç…§Uå‹ç½‘ç»œç»“æ„æ ¼å¼è¿›è¡Œæ•´ä½“çš„ç½‘ç»œç»“æ„æ­å»ºï¼Œä¸‰æ¬¡ä¸‹é‡‡æ ·ï¼Œå››æ¬¡ä¸Šé‡‡æ ·ã€‚

### 3.1.13 æ¨¡å‹å¯è§†åŒ–

è°ƒç”¨é£æ¡¨æä¾›çš„summaryæ¥å£å¯¹ç»„å»ºå¥½çš„æ¨¡å‹è¿›è¡Œå¯è§†åŒ–ï¼Œæ–¹ä¾¿è¿›è¡Œæ¨¡å‹ç»“æ„å’Œå‚æ•°ä¿¡æ¯çš„æŸ¥çœ‹å’Œç¡®è®¤ã€‚


```python
import paddle
from codee.unet import DoveNet

num_classes = 2
IMAGE_SIZE = (224, 224)
network = DoveNet(num_classes)
model = paddle.Model(network)
model.summary((-1, 3,) + IMAGE_SIZE)
```

    -----------------------------------------------------------------------------
      Layer (type)        Input Shape          Output Shape         Param #    
    =============================================================================
        Conv2D-1       [[1, 3, 224, 224]]   [1, 32, 112, 112]         896      
      BatchNorm2D-1   [[1, 32, 112, 112]]   [1, 32, 112, 112]         128      
         ReLU-1       [[1, 32, 112, 112]]   [1, 32, 112, 112]          0       
         ReLU-2       [[1, 32, 112, 112]]   [1, 32, 112, 112]          0       
    SeparableConv2D-1 [[1, 32, 112, 112]]   [1, 64, 112, 112]        2,400     
      BatchNorm2D-2   [[1, 64, 112, 112]]   [1, 64, 112, 112]         256      
         ReLU-3       [[1, 64, 112, 112]]   [1, 64, 112, 112]          0       
    SeparableConv2D-2 [[1, 64, 112, 112]]   [1, 64, 112, 112]        4,736     
      BatchNorm2D-3   [[1, 64, 112, 112]]   [1, 64, 112, 112]         256      
       MaxPool2D-1    [[1, 64, 112, 112]]    [1, 64, 56, 56]           0       
        Conv2D-2      [[1, 32, 112, 112]]    [1, 64, 56, 56]         2,112     
        Encoder-1     [[1, 32, 112, 112]]    [1, 64, 56, 56]           0       
         ReLU-4        [[1, 64, 56, 56]]     [1, 64, 56, 56]           0       
    SeparableConv2D-3  [[1, 64, 56, 56]]     [1, 128, 56, 56]        8,896     
      BatchNorm2D-4    [[1, 128, 56, 56]]    [1, 128, 56, 56]         512      
         ReLU-5        [[1, 128, 56, 56]]    [1, 128, 56, 56]          0       
    SeparableConv2D-4  [[1, 128, 56, 56]]    [1, 128, 56, 56]       17,664     
      BatchNorm2D-5    [[1, 128, 56, 56]]    [1, 128, 56, 56]         512      
       MaxPool2D-2     [[1, 128, 56, 56]]    [1, 128, 28, 28]          0       
        Conv2D-3       [[1, 64, 56, 56]]     [1, 128, 28, 28]        8,320     
        Encoder-2      [[1, 64, 56, 56]]     [1, 128, 28, 28]          0       
         ReLU-6        [[1, 128, 28, 28]]    [1, 128, 28, 28]          0       
    SeparableConv2D-5  [[1, 128, 28, 28]]    [1, 256, 28, 28]       34,176     
      BatchNorm2D-6    [[1, 256, 28, 28]]    [1, 256, 28, 28]        1,024     
         ReLU-7        [[1, 256, 28, 28]]    [1, 256, 28, 28]          0       
    SeparableConv2D-6  [[1, 256, 28, 28]]    [1, 256, 28, 28]       68,096     
      BatchNorm2D-7    [[1, 256, 28, 28]]    [1, 256, 28, 28]        1,024     
       MaxPool2D-3     [[1, 256, 28, 28]]    [1, 256, 14, 14]          0       
        Conv2D-4       [[1, 128, 28, 28]]    [1, 256, 14, 14]       33,024     
        Encoder-3      [[1, 128, 28, 28]]    [1, 256, 14, 14]          0       
         ReLU-8        [[1, 256, 14, 14]]    [1, 256, 14, 14]          0       
    Conv2DTranspose-1  [[1, 256, 14, 14]]    [1, 256, 14, 14]       590,080    
      BatchNorm2D-8    [[1, 256, 14, 14]]    [1, 256, 14, 14]        1,024     
         ReLU-9        [[1, 256, 14, 14]]    [1, 256, 14, 14]          0       
    Conv2DTranspose-2  [[1, 256, 14, 14]]    [1, 256, 14, 14]       590,080    
      BatchNorm2D-9    [[1, 256, 14, 14]]    [1, 256, 14, 14]        1,024     
       Upsample-1      [[1, 256, 14, 14]]    [1, 256, 28, 28]          0       
       Upsample-2      [[1, 256, 14, 14]]    [1, 256, 28, 28]          0       
        Conv2D-5       [[1, 256, 28, 28]]    [1, 256, 28, 28]       65,792     
        Decoder-1      [[1, 256, 14, 14]]    [1, 256, 28, 28]          0       
         ReLU-10       [[1, 256, 28, 28]]    [1, 256, 28, 28]          0       
    Conv2DTranspose-3  [[1, 256, 28, 28]]    [1, 128, 28, 28]       295,040    
     BatchNorm2D-10    [[1, 128, 28, 28]]    [1, 128, 28, 28]         512      
         ReLU-11       [[1, 128, 28, 28]]    [1, 128, 28, 28]          0       
    Conv2DTranspose-4  [[1, 128, 28, 28]]    [1, 128, 28, 28]       147,584    
     BatchNorm2D-11    [[1, 128, 28, 28]]    [1, 128, 28, 28]         512      
       Upsample-3      [[1, 128, 28, 28]]    [1, 128, 56, 56]          0       
       Upsample-4      [[1, 256, 28, 28]]    [1, 256, 56, 56]          0       
        Conv2D-6       [[1, 256, 56, 56]]    [1, 128, 56, 56]       32,896     
        Decoder-2      [[1, 256, 28, 28]]    [1, 128, 56, 56]          0       
         ReLU-12       [[1, 128, 56, 56]]    [1, 128, 56, 56]          0       
    Conv2DTranspose-5  [[1, 128, 56, 56]]    [1, 64, 56, 56]        73,792     
     BatchNorm2D-12    [[1, 64, 56, 56]]     [1, 64, 56, 56]          256      
         ReLU-13       [[1, 64, 56, 56]]     [1, 64, 56, 56]           0       
    Conv2DTranspose-6  [[1, 64, 56, 56]]     [1, 64, 56, 56]        36,928     
     BatchNorm2D-13    [[1, 64, 56, 56]]     [1, 64, 56, 56]          256      
       Upsample-5      [[1, 64, 56, 56]]    [1, 64, 112, 112]          0       
       Upsample-6      [[1, 128, 56, 56]]   [1, 128, 112, 112]         0       
        Conv2D-7      [[1, 128, 112, 112]]  [1, 64, 112, 112]        8,256     
        Decoder-3      [[1, 128, 56, 56]]   [1, 64, 112, 112]          0       
         ReLU-14      [[1, 64, 112, 112]]   [1, 64, 112, 112]          0       
    Conv2DTranspose-7 [[1, 64, 112, 112]]   [1, 32, 112, 112]       18,464     
     BatchNorm2D-14   [[1, 32, 112, 112]]   [1, 32, 112, 112]         128      
         ReLU-15      [[1, 32, 112, 112]]   [1, 32, 112, 112]          0       
    Conv2DTranspose-8 [[1, 32, 112, 112]]   [1, 32, 112, 112]        9,248     
     BatchNorm2D-15   [[1, 32, 112, 112]]   [1, 32, 112, 112]         128      
       Upsample-7     [[1, 32, 112, 112]]   [1, 32, 224, 224]          0       
       Upsample-8     [[1, 64, 112, 112]]   [1, 64, 224, 224]          0       
        Conv2D-8      [[1, 64, 224, 224]]   [1, 32, 224, 224]        2,080     
        Decoder-4     [[1, 64, 112, 112]]   [1, 32, 224, 224]          0       
        Conv2D-9      [[1, 32, 224, 224]]    [1, 2, 224, 224]         578      
    =============================================================================
    Total params: 2,058,690
    Trainable params: 2,051,138
    Non-trainable params: 7,552
    -----------------------------------------------------------------------------
    Input size (MB): 0.57
    Forward/backward pass size (MB): 230.07
    Params size (MB): 7.85
    Estimated Total Size (MB): 238.50
    -----------------------------------------------------------------------------
    





    {'total_params': 2058690, 'trainable_params': 2051138}



### 3.1.14 å¯åŠ¨æ¨¡å‹è®­ç»ƒ

ä½¿ç”¨æ¨¡å‹ä»£ç è¿›è¡ŒModelå®ä¾‹ç”Ÿæˆï¼Œä½¿ç”¨prepareæ¥å£å®šä¹‰ä¼˜åŒ–å™¨ã€æŸå¤±å‡½æ•°å’Œè¯„ä»·æŒ‡æ ‡ç­‰ä¿¡æ¯ï¼Œç”¨äºåç»­è®­ç»ƒä½¿ç”¨ã€‚åœ¨æ‰€æœ‰åˆæ­¥é…ç½®å®Œæˆåï¼Œè°ƒç”¨fitæ¥å£å¼€å¯è®­ç»ƒæ‰§è¡Œè¿‡ç¨‹ï¼Œè°ƒç”¨fitæ—¶åªéœ€è¦å°†å‰é¢å®šä¹‰å¥½çš„è®­ç»ƒæ•°æ®é›†ã€æµ‹è¯•æ•°æ®é›†ã€è®­ç»ƒè½®æ¬¡ï¼ˆEpochï¼‰å’Œæ‰¹æ¬¡å¤§å°ï¼ˆbatch_sizeï¼‰é…ç½®å¥½å³å¯ã€‚


```python
!python codee/train.py
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/setuptools/depends.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
      import imp
    E0222 23:22:06.379097  5901 pybind.cc:1625] Cannot use GPU because you have installed CPU version PaddlePaddle.
    If you want to use GPU, please try to install GPU version PaddlePaddle by: pip install paddlepaddle-gpu
    If you only have CPU, please change CUDAPlace(0) to be CPUPlace().


### 3.1.15 é¢„æµ‹æ•°æ®é›†å‡†å¤‡å’Œé¢„æµ‹

ç»§ç»­ä½¿ç”¨DoveDatasetæ¥å®ä¾‹åŒ–å¾…é¢„æµ‹ä½¿ç”¨çš„æ•°æ®é›†ã€‚

æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨model.predictæ¥å£æ¥å¯¹æ•°æ®é›†è¿›è¡Œé¢„æµ‹æ“ä½œï¼Œåªéœ€è¦å°†é¢„æµ‹æ•°æ®é›†ä¼ é€’åˆ°æ¥å£å†…å³å¯ã€‚


```python
import paddle
from codee.unet import DoveNet
from codee.dove_dataset import DoveDataset
```


```python
num_classes = 2
network = DoveNet(num_classes)
```

### 3.1.16 é¢„æµ‹ç»“æœå¯è§†åŒ–

ä»æˆ‘ä»¬çš„é¢„æµ‹æ•°æ®é›†ä¸­æŠ½3ä¸ªå›¾ç‰‡æ¥çœ‹çœ‹é¢„æµ‹çš„æ•ˆæœï¼Œå±•ç¤ºä¸€ä¸‹åŸå›¾ã€æ ‡ç­¾å›¾å’Œé¢„æµ‹ç»“æœã€‚


```python
import numpy as np
import matplotlib.pyplot as plt
from paddle.vision.transforms import transforms as T
from PIL import Image as PilImage
```


```python
# plt.figure(figsize=(10, 10))

IMAGE_SIZE = (224, 224)
i = 0
idx = 0

with open('./test.txt', 'r') as f:
    for line in f.readlines():
        image_path, label_path = line.strip().split('\t')
        resize_t = T.Compose([
            T.Resize(IMAGE_SIZE)
        ])
        image = resize_t(PilImage.open(image_path))
        label = resize_t(PilImage.open(label_path))

        image = np.array(image).astype('uint8')
        label = np.array(label).astype('uint8')

        if i > 8: 
            break
        plt.subplot(3, 3, i + 1)
        plt.imshow(image)
        plt.title('Input Image')
        plt.axis("off")

        plt.subplot(3, 3, i + 2)
        plt.imshow(label, cmap='gray')
        plt.title('Label')
        plt.axis("off")
        
        # data = predict_results[0][0][idx].transpose((1, 2, 0))
        # mask = np.argmax(data, axis=-1)

        plt.subplot(3, 3, i + 3)
        # plt.imshow(mask.astype('uint8'), cmap='gray')
        plt.title('Predict')
        plt.axis("off")
        i += 3
        idx += 1

plt.show()
```


![png](output_32_0.png)


## 3.2 åŸºäºPaddleSegä½¿ç”¨U-Netç½‘ç»œå®ç°é¸½å­å›¾åƒçš„è¯­ä¹‰åˆ†å‰²ä»»åŠ¡

### 3.2.1 å®‰è£…PaddleSeg


```python
!pip install paddleseg
```

    Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple
    Collecting paddleseg
      Downloading https://pypi.tuna.tsinghua.edu.cn/packages/1b/5b/44c7fc5b5f030553ecf391bba0e484856f31860b24d7730d53c41aa2cc3d/paddleseg-2.4.0-py3-none-any.whl (275 kB)
         |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 275 kB 6.9 MB/s            
    [?25hRequirement already satisfied: sklearn in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (0.0)
    Requirement already satisfied: flake8 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (4.0.1)
    Requirement already satisfied: filelock in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (3.0.12)
    Requirement already satisfied: scipy in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (1.3.0)
    Requirement already satisfied: opencv-python in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (4.1.1.26)
    Requirement already satisfied: visualdl>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (2.2.0)
    Requirement already satisfied: pre-commit in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (1.21.0)
    Requirement already satisfied: pyyaml>=5.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (5.1.2)
    Requirement already satisfied: prettytable in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (0.7.2)
    Requirement already satisfied: tqdm in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (4.27.0)
    Requirement already satisfied: yapf==0.26.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from paddleseg) (0.26.0)
    Requirement already satisfied: matplotlib in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (2.2.3)
    Requirement already satisfied: bce-python-sdk in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (0.8.53)
    Requirement already satisfied: six>=1.14.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (1.16.0)
    Requirement already satisfied: pandas in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (1.1.5)
    Requirement already satisfied: flask>=1.1.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (1.1.1)
    Requirement already satisfied: protobuf>=3.11.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (3.14.0)
    Requirement already satisfied: shellcheck-py in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (0.7.1.1)
    Requirement already satisfied: Pillow>=7.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (8.2.0)
    Requirement already satisfied: Flask-Babel>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (1.0.0)
    Requirement already satisfied: requests in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (2.24.0)
    Requirement already satisfied: numpy in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from visualdl>=2.0.0->paddleseg) (1.19.5)
    Requirement already satisfied: pyflakes<2.5.0,>=2.4.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8->paddleseg) (2.4.0)
    Requirement already satisfied: mccabe<0.7.0,>=0.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8->paddleseg) (0.6.1)
    Requirement already satisfied: pycodestyle<2.9.0,>=2.8.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8->paddleseg) (2.8.0)
    Requirement already satisfied: importlib-metadata<4.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flake8->paddleseg) (4.2.0)
    Requirement already satisfied: identify>=1.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (1.4.10)
    Requirement already satisfied: nodeenv>=0.11.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (1.3.4)
    Requirement already satisfied: toml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (0.10.0)
    Requirement already satisfied: virtualenv>=15.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (16.7.9)
    Requirement already satisfied: cfgv>=2.0.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (2.0.1)
    Requirement already satisfied: aspy.yaml in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from pre-commit->paddleseg) (1.3.0)
    Requirement already satisfied: scikit-learn in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from sklearn->paddleseg) (0.22.1)
    Requirement already satisfied: Jinja2>=2.10.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->paddleseg) (2.11.0)
    Requirement already satisfied: Werkzeug>=0.15 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->paddleseg) (0.16.0)
    Requirement already satisfied: itsdangerous>=0.24 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->paddleseg) (1.1.0)
    Requirement already satisfied: click>=5.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from flask>=1.1.1->visualdl>=2.0.0->paddleseg) (7.0)
    Requirement already satisfied: pytz in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0->paddleseg) (2019.3)
    Requirement already satisfied: Babel>=2.3 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Flask-Babel>=1.0.0->visualdl>=2.0.0->paddleseg) (2.8.0)
    Requirement already satisfied: typing-extensions>=3.6.4 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from importlib-metadata<4.3->flake8->paddleseg) (4.0.1)
    Requirement already satisfied: zipp>=0.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from importlib-metadata<4.3->flake8->paddleseg) (3.7.0)
    Requirement already satisfied: future>=0.6.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from bce-python-sdk->visualdl>=2.0.0->paddleseg) (0.18.0)
    Requirement already satisfied: pycryptodome>=3.8.0 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from bce-python-sdk->visualdl>=2.0.0->paddleseg) (3.9.9)
    Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,>=2.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->paddleseg) (3.0.7)
    Requirement already satisfied: python-dateutil>=2.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->paddleseg) (2.8.2)
    Requirement already satisfied: cycler>=0.10 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->paddleseg) (0.10.0)
    Requirement already satisfied: kiwisolver>=1.0.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from matplotlib->visualdl>=2.0.0->paddleseg) (1.1.0)
    Requirement already satisfied: chardet<4,>=3.0.2 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->paddleseg) (3.0.4)
    Requirement already satisfied: idna<3,>=2.5 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->paddleseg) (2.8)
    Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->paddleseg) (2019.9.11)
    Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from requests->visualdl>=2.0.0->paddleseg) (1.25.6)
    Requirement already satisfied: joblib>=0.11 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from scikit-learn->sklearn->paddleseg) (0.14.1)
    Requirement already satisfied: MarkupSafe>=0.23 in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from Jinja2>=2.10.1->flask>=1.1.1->visualdl>=2.0.0->paddleseg) (2.0.1)
    Requirement already satisfied: setuptools in /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages (from kiwisolver>=1.0.1->matplotlib->visualdl>=2.0.0->paddleseg) (41.4.0)
    Installing collected packages: paddleseg
    Successfully installed paddleseg-2.4.0
    [33mWARNING: You are using pip version 21.3.1; however, version 22.0.3 is available.
    You should consider upgrading via the '/opt/conda/envs/python35-paddle120-env/bin/python -m pip install --upgrade pip' command.[0m


### 3.2.2 å…‹éš†æˆ–è€…è§£å‹ç¼©PaddleSeg
ä¸ºé¿å…ç”±äºç½‘ç»œé€ æˆçš„ä¸‹è½½å›°éš¾é—®é¢˜ï¼Œè¿™é‡Œé‡‡ç”¨è§£å‹ç¼©çš„æ–¹æ³•ã€‚ä¹Ÿå¯ä»¥é‡‡ç”¨å…‹éš†çš„æ–¹æ³•è·å–æœ€æ–°çš„PaddleSegã€‚
```
!git clone https://github.com/PaddlePaddle/PaddleSeg.git
```


```python
!unzip -oq /home/aistudio/data/data75217/PaddleSeg.zip -d work
```

### 3.2.3 å¼€å§‹è®­ç»ƒ
ä½¿ç”¨PaddleSegæ—¶çš„é…ç½®ä¿¡æ¯æ˜¯é‡‡ç”¨ymlæ–‡ä»¶æè¿°çš„ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯unet.ymlæ–‡ä»¶.


```python
## ä½¿ç”¨U-netè¿›è¡Œè®­ç»ƒ
!python work/PaddleSeg/train.py --config unet.yml --save_interval 2000
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/setuptools/depends.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
      import imp
    /home/aistudio/work/PaddleSeg/paddleseg/cvlibs/param_init.py:89: DeprecationWarning: invalid escape sequence \s
      """
    /home/aistudio/work/PaddleSeg/paddleseg/models/losses/binary_cross_entropy_loss.py:82: DeprecationWarning: invalid escape sequence \|
      """
    /home/aistudio/work/PaddleSeg/paddleseg/models/losses/lovasz_loss.py:50: DeprecationWarning: invalid escape sequence \i
      """
    /home/aistudio/work/PaddleSeg/paddleseg/models/losses/lovasz_loss.py:77: DeprecationWarning: invalid escape sequence \i
      """
    /home/aistudio/work/PaddleSeg/paddleseg/models/losses/lovasz_loss.py:120: DeprecationWarning: invalid escape sequence \i
      """
    2022-02-22 22:56:17 [INFO]	
    ------------Environment Information-------------
    platform: Linux-4.4.0-166-generic-x86_64-with-debian-stretch-sid
    Python: 3.7.4 (default, Aug 13 2019, 20:35:49) [GCC 7.3.0]
    Paddle compiled with cuda: False
    GCC: gcc (Ubuntu 7.5.0-3ubuntu1~16.04) 7.5.0
    PaddlePaddle: 2.2.2
    OpenCV: 4.1.1
    ------------------------------------------------
    Traceback (most recent call last):
      File "work/PaddleSeg/train.py", line 154, in <module>
        main(args)
      File "work/PaddleSeg/train.py", line 117, in main
        train_dataset = cfg.train_dataset
      File "/home/aistudio/work/PaddleSeg/paddleseg/cvlibs/config.py", line 255, in train_dataset
        return self._load_object(_train_dataset)
      File "/home/aistudio/work/PaddleSeg/paddleseg/cvlibs/config.py", line 296, in _load_object
        return component(**params)
      File "/home/aistudio/work/PaddleSeg/paddleseg/datasets/dataset.py", line 135, in __init__
        " image_name{}label_name\\n".format(separator))
    ValueError: File list format incorrect! In training or evaluation task it should be image_name label_name\n


### 3.2.4 å¼€å§‹é¢„æµ‹


```python
## å°†æµ‹è¯•å›¾ç‰‡æ‹·è´åˆ°æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸­
import os
import shutil

if not os.path.exists('test_imgs'):
    os.mkdir('test_imgs')

with open('test.txt', 'r') as f:
    paths = f.readlines()
    i = 0
    for path in paths:
        img, label = path.strip().split('\t')
        shutil.copy(img, 'test_imgs/t'+str(i)+'.png')
        i += 1
```


```python
## å°†æ ‡ç­¾å›¾ç‰‡æ‹·è´åˆ°æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸­
if not os.path.exists('label_imgs'):
    os.mkdir('label_imgs')

with open('test.txt', 'r') as f:
    paths = f.readlines()
    i = 0
    for path in paths:
        img, label = path.strip().split('\t')
        shutil.copy(label, 'label_imgs/t'+str(i)+'.png')
        i += 1
```


```python
## å¼€å§‹é¢„æµ‹å¹¶ä¿å­˜é¢„æµ‹åçš„å›¾ç‰‡
!python work/PaddleSeg/predict.py --image_path test_imgs \
--model_path output/iter_10000/model.pdparams \
--save_dir saved_imges \
--crop_size 512 512 \
--config unet.yml
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/setuptools/depends.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
      import imp
    Traceback (most recent call last):
      File "work/PaddleSeg/predict.py", line 177, in <module>
        main(args)
      File "work/PaddleSeg/predict.py", line 140, in main
        val_dataset = cfg.val_dataset
      File "/home/aistudio/work/PaddleSeg/paddleseg/cvlibs/config.py", line 262, in val_dataset
        return self._load_object(_val_dataset)
      File "/home/aistudio/work/PaddleSeg/paddleseg/cvlibs/config.py", line 296, in _load_object
        return component(**params)
      File "/home/aistudio/work/PaddleSeg/paddleseg/datasets/dataset.py", line 135, in __init__
        " image_name{}label_name\\n".format(separator))
    ValueError: File list format incorrect! In training or evaluation task it should be image_name label_name\n


### 3.2.5 ç»“æœå¯è§†åŒ–


```python
## åˆ›å»ºéœ€è¦å¯è§†åŒ–çš„å›¾ç‰‡åˆ—è¡¨
test_images = os.listdir('test_imgs')
label_images = os.listdir('label_imgs')
# predicted_images = os.listdir('saved_imges/pseudo_color_prediction')

test_images = ['test_imgs/' + path for path in test_images if not path.startswith('.')]
label_images = ['label_imgs/' + path for path in label_images if not path.startswith('.')]
# predicted_images = ['saved_imges/pseudo_color_prediction/' + path for path in predicted_images if not path.startswith('.')]

test_images.sort()
label_images.sort()
# predicted_images.sort()
```


```python
## å¼€å§‹å¯è§†åŒ–
from paddle.vision.transforms import transforms as T
import matplotlib.pyplot as plt
from PIL import Image as PilImage
import numpy as np

plt.figure(figsize=(10, 10))

IMAGE_SIZE = (224, 224)
i = 0

for j in range(len(test_images)):
    test_path = test_images[j]
    label_path = label_images[j]
    # predicted_path = predicted_images[j]

    resize_t = T.Compose([
        T.Resize(IMAGE_SIZE)
    ])
    image = resize_t(PilImage.open(test_path))
    label = resize_t(PilImage.open(label_path))
    # predicted = resize_t(PilImage.open(predicted_path))

    image = np.array(image).astype('uint8')
    label = np.array(label).astype('uint8')
    # predicted = np.array(predicted).astype('uint8')

    if i > 8: 
        break
    plt.subplot(3, 3, i + 1)
    plt.imshow(image)
    plt.title('Input Image')
    plt.axis("off")

    plt.subplot(3, 3, i + 2)
    plt.imshow(label, cmap='gray')
    plt.title('Label')
    plt.axis("off")

    plt.subplot(3, 3, i + 3)
    # plt.imshow(predicted, cmap='gray')
    plt.title('Predict')
    plt.axis("off")
    i += 3
    j += 1

plt.show()
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/cbook/__init__.py:2349: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working
      if isinstance(obj, collections.Iterator):
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/cbook/__init__.py:2366: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working
      return list(data) if isinstance(data, collections.MappingView) else data
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/image.py:425: DeprecationWarning: np.asscalar(a) is deprecated since NumPy v1.16, use a.item() instead
      a_min = np.asscalar(a_min.astype(scaled_dtype))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/image.py:426: DeprecationWarning: np.asscalar(a) is deprecated since NumPy v1.16, use a.item() instead
      a_max = np.asscalar(a_max.astype(scaled_dtype))



![png](output_46_1.png)


# 4. æ€»ç»“

1. æœ¬é¡¹ç›®ä»é›¶å¼€å§‹ï¼Œå…¨æµç¨‹çš„ä»‹ç»äº†åŸºäºPaddleçš„å›¾åƒåˆ†å‰²æ–¹æ³•ã€‚

2. åœ¨è‡ªå»ºåˆ†å‰²æ•°æ®é›†çš„åŸºç¡€ä¸Šï¼Œåˆ†åˆ«ä½¿ç”¨Paddle2.0å’ŒPaddleSeg2.0ä»‹ç»äº†åŸºäºU-Netçš„å›¾åƒåˆ†å‰²æ–¹æ³•ã€‚

3. é’ˆå¯¹å›¾åƒåˆ†å‰²ä»»åŠ¡ï¼ŒPaddleSeg2.0ç›¸å¯¹äºPaddle2.0å…·æœ‰ä½¿ç”¨ç®€å•ã€æ¨¡å‹ä¸°å¯Œã€æ•ˆæœå¥½ç­‰ä¼˜ç‚¹ï¼Œå»ºè®®ä½¿ç”¨ã€‚

4. é‡‡ç”¨å…¶å®ƒç½‘ç»œçš„å›¾åƒåˆ†å‰²æ–¹æ³•å¯ä»¥åœ¨æœ¬é¡¹ç›®çš„åŸºç¡€ä¸Šä¿®æ”¹å®ç°ã€‚

5. æ¬¢è¿forkï¼Œè¯„è®ºï¼Œå…±åŒå­¦ä¹ ã€‚
